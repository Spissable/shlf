name: Release
on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  test:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v6
      - run: brew install swiftlint
      - run: swiftlint --strict
      - run: swift build
      - run: swift test

  release:
    needs: [test]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - id: semantic
        uses: cycjimmy/semantic-release-action@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-binary:
    needs: [test, release]
    if: needs.release.outputs.new_release_published == 'true'
    runs-on: macos-15
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
      - run: swift build -c release --arch arm64 --arch x86_64
      - name: Build .app bundle
        run: |
          APP="Shlf.app/Contents"
          mkdir -p "${APP}/MacOS" "${APP}/Resources"

          cp .build/apple/Products/Release/shlf "${APP}/MacOS/shlf"

          # Convert PNG to icns
          ICONSET="AppIcon.iconset"
          mkdir "$ICONSET"
          for size in 16 32 128 256 512; do
            sips -z $size $size assets/AppIcon.png --out "${ICONSET}/icon_${size}x${size}.png" > /dev/null
          done
          for size in 32 64 256 512 1024; do
            half=$((size / 2))
            sips -z $size $size assets/AppIcon.png --out "${ICONSET}/icon_${half}x${half}@2x.png" > /dev/null
          done
          iconutil -c icns "$ICONSET" -o "${APP}/Resources/AppIcon.icns"
          rm -rf "$ICONSET"

          cat > "${APP}/Info.plist" << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleExecutable</key>
            <string>shlf</string>
            <key>CFBundleIconFile</key>
            <string>AppIcon</string>
            <key>CFBundleIdentifier</key>
            <string>dev.spiss.shlf</string>
            <key>CFBundleName</key>
            <string>Shlf</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>${{ needs.release.outputs.new_release_version }}</string>
            <key>LSMinimumSystemVersion</key>
            <string>14.0</string>
            <key>LSUIElement</key>
            <true/>
          </dict>
          </plist>
          PLIST

          zip -r Shlf.app.zip Shlf.app
      - run: gh release upload "v${{ needs.release.outputs.new_release_version }}" Shlf.app.zip
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-tap:
    needs: [release, build-binary]
    if: needs.release.outputs.new_release_published == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Update Homebrew cask
        env:
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
          VERSION: ${{ needs.release.outputs.new_release_version }}
        run: |
          ZIP_URL="https://github.com/spissable/shlf/releases/download/v${VERSION}/Shlf.app.zip"
          SHA256=$(curl -sL "$ZIP_URL" | shasum -a 256 | cut -d ' ' -f 1)

          git clone https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/spissable/homebrew-tap.git tap
          cd tap

          sed -i "s|url \".*\"|url \"${ZIP_URL}\"|" Casks/shlf.rb
          sed -i "s|sha256 \".*\"|sha256 \"${SHA256}\"|" Casks/shlf.rb
          sed -i "s|version \".*\"|version \"${VERSION}\"|" Casks/shlf.rb

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/shlf.rb
          git commit -m "feat: update shlf to v${VERSION}"
          git push
